image: node:latest

cache:
  paths:
    - node_modules/
    - .yarn
    - dist/

before_script:
  - apt-get update

stages:
  - build
  - test
  - deploy

build_project:
  stage: build
  only:
    - master
  script:
    - yarn config set cache-folder .yarn
    - yarn install
    - npm run build --prod

test_with_lab:
  stage: test
  only:
    - master
  script:
    - apt-get -y install chromium
    - export CHROME_BIN=/usr/bin/chromium
    - yarn config set cache-folder .yarn
    - yarn install
    - npm run test

deploy_front:
  stage: deploy
  only:
    - master
  script:
    - apt-get -y install ansible
    - echo -e $ANSIBLE_KEY_SSH_FRONT > front_server
    - echo -e $ANSIBLE_HOSTS > hosts.yml
    - ansible-playbook playbooks/playbook.yml -i hosts
  after_script:
    - rm front_server hosts
